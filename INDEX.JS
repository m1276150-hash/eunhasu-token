const StellarSDK = require("@stellar/stellar-sdk");

// Pi Testnet Horizon Server
const server = new StellarSDK.Horizon.Server("https://api.testnet.minepi.com");
const NETWORK_PASSPHRASE = "Pi Testnet";

// -----------------------------------------------------------
// ğŸ”‘ 1. í‚¤ ì •ë³´ ì‚½ì… (ìƒˆë¡œ ìƒì„±í•œ A''ì™€ B'' ì§€ê°‘ì˜ Secret Key)
// -----------------------------------------------------------
const issuerKeypair = StellarSDK.Keypair.fromSecret("SACY7F7K3IA6SLWDK4UUVIEE4RIK6F6RHJZRNQSFPM24VUP2YXTSEQ5D"); // A'' ì§€ê°‘ (ë°œí–‰ì)
const distributorKeypair = StellarSDK.Keypair.fromSecret("SBKCWNZP4INHSCPSNEZ6TVT3Z2K4GBO33SV2RNDCLF3LNV65UZH5B3T2"); // B'' ì§€ê°‘ (ìˆ˜ì‹ ì)

// -----------------------------------------------------------
// ğŸ“ 2. í† í° ë° ë„ë©”ì¸ ì •ë³´ ì„¤ì •
// -----------------------------------------------------------
const CUSTOM_TOKEN_CODE = "EUNHASU"; // í† í° ì½”ë“œ ì„¤ì •
const MINT_AMOUNT = "50000000"; // 5ì²œë§Œ ê°œ
const HOME_DOMAIN_NAME = "EUNHASU.com"; // Home Domain ì„¤ì • (ì‹¤ì œ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)
const customToken = new StellarSDK.Asset(CUSTOM_TOKEN_CODE, issuerKeypair.publicKey());

async function runFullIssuanceProcess() {
    try {
        console.log(`\n======================================================`);
        console.log(`[ğŸš€ í”„ë¡œì„¸ìŠ¤ ì‹œì‘] í† í°: ${CUSTOM_TOKEN_CODE}, ë°œí–‰ì: ${issuerKeypair.publicKey()}`);
        console.log(`======================================================`);

        // ê¸°ë³¸ ì •ë³´ ë¡œë“œ ë° ìˆ˜ìˆ˜ë£Œ ì„¤ì •
        const response = await server.ledgers().order("desc").limit(1).call();
        const latestBlock = response.records[0];
        const baseFee = latestBlock.base_fee_in_stroops;
        
        const distributorAccount = await server.loadAccount(distributorKeypair.publicKey());
        const issuerAccount = await server.loadAccount(issuerKeypair.publicKey());
        
        // ====================================================================================
        // 1ë‹¨ê³„: B'' ì§€ê°‘ Trustline ì„¤ì •
        // ====================================================================================
        console.log("[1/3] B'' ì§€ê°‘ Trustline ì„¤ì • ì¤‘...");
        
        const trustlineTransaction = new StellarSDK.TransactionBuilder(distributorAccount, {
            fee: baseFee,
            networkPassphrase: NETWORK_PASSPHRASE,
            timebounds: await server.fetchTimebounds(90),
        })
            .addOperation(StellarSDK.Operation.changeTrust({ asset: customToken, limit: undefined }))
            .build();

        trustlineTransaction.sign(distributorKeypair);

        await server.submitTransaction(trustlineTransaction);
        console.log("âœ… Trustline created successfully");

        // ====================================================================================
        // 2ë‹¨ê³„: í† í° ë°œí–‰ (A''ì—ì„œ B''ë¡œ 5ì²œë§Œ EUNHASU ì „ì†¡)
        // ====================================================================================
        console.log(`[2/3] í† í° ë°œí–‰ (${MINT_AMOUNT} ê°œ) ë° ì „ì†¡ ì¤‘...`);
        
        const paymentTransaction = new StellarSDK.TransactionBuilder(issuerAccount, {
            fee: baseFee,
            networkPassphrase: NETWORK_PASSPHRASE,
            timebounds: await server.fetchTimebounds(90),
        })
            .addOperation(
                StellarSDK.Operation.payment({
                    destination: distributorKeypair.publicKey(),
                    asset: customToken,
                    amount: MINT_AMOUNT,
                })
            )
            .build(); 

        paymentTransaction.sign(issuerKeypair);

        await server.submitTransaction(paymentTransaction);
        console.log("âœ… Token issued successfully");

        // ====================================================================================
        // 3ë‹¨ê³„: Home Domain ì„¤ì • (ë°œí–‰ìì˜ ë©”íƒ€ë°ì´í„° ì„¤ì •)
        // ====================================================================================
        // í† í° ë°œí–‰ í›„ ì‹œí€€ìŠ¤ ë²ˆí˜¸ê°€ ì¦ê°€í–ˆìœ¼ë¯€ë¡œ, ê³„ì •ì„ ë‹¤ì‹œ ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.
        const updatedIssuerAccount = await server.loadAccount(issuerKeypair.publicKey());
        
        console.log(`[3/3] Home Domain (${HOME_DOMAIN_NAME}) ì„¤ì • ì¤‘...`);

        const setOptionsTransaction = new StellarSDK.TransactionBuilder(updatedIssuerAccount, {
            fee: baseFee,
            networkPassphrase: NETWORK_PASSPHRASE,
            timebounds: await server.fetchTimebounds(90),
        })
            .addOperation(StellarSDK.Operation.setOptions({ homeDomain: HOME_DOMAIN_NAME })) 
            .build();

        setOptionsTransaction.sign(issuerKeypair);

        await server.submitTransaction(setOptionsTransaction);
        console.log(`âœ… Home Domain ${HOME_DOMAIN_NAME} ì„¤ì • ì„±ê³µ!`);


        // ====================================================================================
        // ìµœì¢… í™•ì¸: B'' ì§€ê°‘ì˜ ì”ê³  í™•ì¸
        // ====================================================================================
        console.log("\n[âœ¨ ìµœì¢… ê²°ê³¼] B'' ì§€ê°‘ì˜ ì”ê³  í™•ì¸ ì¤‘...");
        const finalDistributorAccount = await server.loadAccount(distributorKeypair.publicKey());
        finalDistributorAccount.balances.forEach((balance) => {
            if (balance.asset_code === CUSTOM_TOKEN_CODE && balance.asset_issuer === issuerKeypair.publicKey()) {
                console.log(`\n======================================`);
                console.log(`â­ ${balance.asset_code} ìµœì¢… ì”ê³ : ${balance.balance} (5ì²œë§Œ ê°œ í™•ì¸!)`);
                console.log(`======================================\n`);
            } else if (balance.asset_type === "native") {
                console.log(`Test-Pi (XLM) ì”ê³ : ${balance.balance}`);
            }
        });

    } catch (error) {
        console.error("âŒ í”„ë¡œì„¸ìŠ¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        if (error.response && error.response.data && error.response.data.extras && error.response.data.extras.result_codes) {
             console.error("Result Codes:", error.response.data.extras.result_codes);
        } else {
             console.error(error.message);
        }
    }
}

runFullIssuanceProcess();